# Basics

## Assembly

### Calling Convention

| Name | Architecture | OS | Integer Arguments | Floating Point Arguments | Integer Return Value | Floating Point Return Value | System Call Number | Callee-saved Registers | Caller-saved Registers |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
| System V ABI | x64 | Linux, BSD, Solaris | `rdi`, `rsi`, `rdx`, `rcx`, `r8`, `r9`, stack RTL | `xmm0` ~ `xmm7` | `rax` | `xmm0` | N/A | `rbx`, `rbp`, `rsp`, `r12`, `r13`, `r14`, `r15` | Others |
| System V ABI (syscall) | x64 | Linux, BSD, Solaris | `rdi`, `rsi`, `rdx`, `r10`, `r8`, `r9` | N/A | `rax` | N/A | `rax` | N/A | N/A |
| Microsoft x64 | x64 | Windows, UEFI | `rcx`, `rdx`, `r8`, `r9`, stack RTL | `xmm0` ~ `xmm3` | `rax` | `xmm0` | N/A | `rbx`, `rbp`, `rdi`, `rsi`, `rsp`, `r12`, `r13`, `r14`, `r15` | Others |

## Cross Compiling & Cross Debugging

### Cross Compiling

```bash
aarch64-linux-gnu-gcc vuln.c -o vuln
```

### Cross Debugging

One terminal:
```bash
qemu-aarch64 -g 1234 vuln
```
Another terminal:
```bash
gdb-multiarch
(gdb) file vuln
(gdb) set architecture aarch64
(gdb) target remote localhost:1234
```

## ASLR

- ASLR randomizes the address space location of a process
- Some randomized adderss space locations:
    - stack
    - heap
    - libraries
    - mmap addresses
    - Ehe base of the executable
- Turn on/off ASLR
    - Controled by `/proc/sys/kernel/randomize_va_space`
        - 0: Turn off ASLR
        - 1: Stack, libraries, and mmap addresses are randomized. **Heap is not randomized**
        - 2: Stack, heap, libraries, and mmap addresses are all randomized.
- Finding the address/offset of functions
    - e.g. `system`
        ```bash!
        readelf -W -s /lib/x86_64-linux-gnu/libc.so.6 | grep system
        ```
- Finding the address/offset of a string
    - e.g. `"/bin/sh"`
        ```bash!
        strings -a -t x /lib/x86_64-linux-gnu/libc.so.6 | grep "/bin/sh"
        ```

## ELF Security properties

### NX

- Stands for non-executable.
- Similar to DEP on Windows.
- Mark writable areas of memory as non-executable.
- Check if NX is enabled:
    - Check whether `GNU_STACK` is `RW` or `RWX`
        ```bash!
        readelf -W -l ./binary | grep GNU_STACK
        ```
- Compiler flags:
    - NX is enabled by default
    - `-z execstack`: disable NX

### Canary

- Unpredictable values that are placed between variables and return addresses on the stack.
- The unpredictable value is obtained from `fs:0x28`
- Canary always ends with `\0` (Prevent null byte overflow)
- Check if canary is enabled:
    - Detect `__stack_chk_fail` or `__intel_security_cookie` function
        ```bash!
        readelf -W -s ./binary | grep -E '__stack_chk_fail|__intel_security_cookie'
        ```
- Compiler flags:
    - `-fstack-protector-all`: enable canary
    - `-fno-stack-protector`: disable canary

### RELRO

- Stands for Relocation Read-Only.
- Determine whether the Global Offset Table (GOT) is readonly.
- Types of RELRO:
    - No RELRO: `.got` and `.got.plt` are marked as readable and writable.
    - Partial RELRO: `.got` is read only, but `.got.plt` is writeable.
    - Full RELRO: `.got` and `.got.plt` are marked as readonly.
- Check if RELRO is enabled:
    - No RELRO: The `GNU_RELRO` segment does not exist.
    - Partial RELRO: `GNU_RELRO` exists, but the `BIND_NOW` tag does not exist.
    - Full RELRO: Both `GNU_RELRO` and `BIND_NOW`  exist.
        ```bash!
        readelf -W -l ./binary | grep GNU_RELRO
        readelf -W -d ./binary | grep BIND_NOW
        ```
- Compiler flags
    - `-Wl,-z,relro,-z,now`: Full RELRO
    - `-Wl,-z,relro`: Partial RELRO
    - `-Wl,-z,norelro`: No RELRO

### PIE

- Stands for position-independent executable
- Most of the time, PIE is enabled only for libraries
- Check if PIE is enabled:
    - Check if `e_type` is `ET_EXEC` (non-PIE) or `ET_DYN` (PIE)
- Compiler flags
    - `-fpie`: enable PIE
    - `-fno-pie`: disable PIE

### Fortify

- Enabling the `FORTIFY_SOURCE` macro
- Dangerous functions (such as `memcpy`, `strcpy`, ...) will be checked at compile-time or run-time. 
    - Dangerous functions will be replaced with fortified functions (such as `__memcpy_chk`, `__strcpy_chk`, ...) that checks for a potential buffer overflow.
- Enable `FORTIFY_SOURCE`
    - `-D_FORTIFY_SOURCE=1`: adds checks at compile time only.
    - `-D_FORTIFY_SOURCE=2`: adds checks at compile-time and run-time.

### checksec

- Identify security properties on Linux binaries
- e.g.
    ```bash!
    checksec --file=/usr/bin/python3
    ```
    ```
    [*] '/usr/bin/python3'
        Arch:     amd64-64-little
        RELRO:    Partial RELRO
        Stack:    Canary found
        NX:       NX enabled
        PIE:      No PIE (0x400000)
        FORTIFY:  Enabled
    ```

## Windows Process Mitigation

### DEP

- Stands for *Data Execution Prevention*
- Similar to NX on Linux
- Mark writable areas of memory as non-executable

### SEHOP

- Stands for *Structured Exception Handling Overwrite Protection*
- Helps prevent SEH Overwriting

### ASLR

- Randomizes the address space location of a process
- Some randomized address space locations:
    - Executables
    - DLLs
    - heap
    - stack
    - PEB
    - TEB
