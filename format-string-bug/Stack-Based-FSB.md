# Stack-based FSB

## Requirement

`printf(buff)`, where `buff` is a stack local variable.

## Stack Memory Leak

- Leak continuous stack memory using `%p.%p.%p.%p` (`.` is just a conspicuous separator. You can use any reasonable separator you like)
- Use `%N$p` to leak the `N`'th argument

> [!NOTE]
> `%p` prints the pointer representation of a value, which is basically a hex value with the `0x` prefix. You can also use `%d`, `%llx`, etc to print the value.

> [!NOTE]
> I recommend finding the value of `N` by trial and error and inspecting the stack memory through gdb.

## Arbitrary Read

1. Place `addr` (the address you want to read from) onto the stack
2. Call `printf("%N$s")` to read the string value from `addr`, where the `N`'th argument contains `addr`.

## Arbitrary Write

### Writing Bytes

Suppose you want to write byte `M` to address `addr`

1. Place `addr` (the address you want to write to) onto the stack.
2. Call `printf("%Mc%N$hhn")` to write `M` as a *char* to `addr`, where the `N`'th argument contains `addr`.

### Writing Integers / Longs

Suppose you want to write integer value `val` to address `addr`

1. For `i` from 0 to 7:
    1. Place `addr + i` (the address you want to write to) onto the stack.
    2. Call `printf("%Mc%N$hhn")`, where `M` is the `i`'th byte of `val` (`(val >> (i * 8)) & 0xff`), and the `N`'th argument contains `addr + i`.

> [!WARNING]
> You can also use `$hn` `printf("%Mc%N$hn")` to write `M` as a *short* to `addr` if there are length restrictions on `buff`.

> [!NOTE]
> If you want to write a 64 bit address to a zeroed-out memory region, you can loop from 0 to 6 (instead of 8). This is because the last two bytes of the address will always be 0.

## Pwntools

The [`fmtstr`](https://docs.pwntools.com/en/stable/fmtstr.html) class in pwntools can help you write FSB payloads easily.

#### Example

```python
# write `0xdeadbeef` to `0x8048000`, and the 7th argument contains `0x8048000`
fmtstr_payload(7, { 0x8048000: 0xdeadbeef } )
# b'%239c%13$lln%190c%14$hhn%17c%15$hhn%32c%16$hhnaa\x00\x80\x04\x08\x00\x00\x00\x00\x02\x80\x04\x08\x00\x00\x00\x00\x01\x80\x04\x08\x00\x00\x00\x00\x03\x80\x04\x08\x00\x00\x00\x00'
```