# Stack Pivoting

## Scenario

- Stack overflow (at least 8 bytes).
- There is a lack of space on the stack to perform a full ROP attack.

## Idea

- Place your ROP gadget in a larger, writable memory area.
- Control the `rsp` register and move it there.

## Gadgets that change `rsp`:

- `leave ; ret`
    - `leave ; ret` appears at the end of each function (function epilogue). Thus, this gadget can be easily found anywhere.
    - Only 8 bytes of buffer overflow is required.
    - Methodology:
        1. Through buffer overflow
            1. Change old `rbp` to a controllable, writable area (e.g. bss or heap). Let's name it `real_rop_addr`.
            2. Change the return address to `leave ; ret`.
        2. Place your real ROP gadget at `real_rop_addr + 0x8`.
    - Explanation
        1. Before a function returns, `rbp` is restored back to its old value (`real_rop_addr`).
        2. `leave` is equivalent to `mov rsp, rbp; pop rbp`, so
            1. After `mov rsp, rbp`, the value of `rbp` (`real_rop_addr`) is assigned to `rsp`.
            2. After `pop rbp`, `rsp` becomes `real_rop_addr + 0x8`.
            3. After `ret`, `rip` becomes `-(real_rop_addr + 0x8)`. 
    - Stack layout
        | Original stack layout | Overwritten stack layout |
        | :-: | :-: |
        | `local variable` | `local variable` |
        | `overflowed buffer` | **`0x41414141`** |
        | `overflowed buffer` | **`0x41414141`** |
        | `old stack frame` | **`real_rop_addr`** |
        | `return address` | **`leave ; ret`** |
        
        | writable area (`real_rop_addr`) layout |
        | :-: |
        | `0x41414141` |
        | `real ROP chain` |
        | ... |
        | ... |
        | ... |
        | ... |
- `pop rsp`
    - The most useful, but the least likely to exist
    - Stack layout
        | Original stack layout | Overwritten stack layout |
        | :-: | :-: |
        | `local variable` | `local variable` |
        | `overflowed buffer` | **`0x41414141`** |
        | `overflowed buffer` | **`0x41414141`** |
        | `old stack frame` | **`0x41414141`** |
        | `return address` | **`pop rsp ; ret`** |
        | ... | `real_rop_addr` |
        
        | writable area (`real_rop_addr`) layout |
        | :-: |
        | `0x41414141` |
        | `real ROP chain` |
        | ... |
        | ... |
        | ... |
        | ... |
- `mov rsp, <reg64>` or `xchg rsp, <reg64>`
    - Use a `pop <reg64>` gadget to store `real_rop_addr`. Then, use `xchg` or `mov` gadgets to set `rsp`.
    - Drawbacks
        - Requires more than 8 bytes
        - `mov rsp, <reg64>` and `xchg rsp, <reg64>` are more difficult to find.
