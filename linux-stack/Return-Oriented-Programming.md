# Return Oriented Programming (ROP)

## Scenario

- Stack overflow
- Stack not writable

## Idea

- Overwrite the **return address** to **ROP gadgets**.

## Stack layout

| Original stack layout | Overwritten stack layout |
| :-: | :-: |
| `local variable` | `local variable` |
| `overflowed buffer` | **`0x41414141`** |
| `overflowed buffer` | **`0x41414141`** |
| `old stack frame` | **`0x41414141`** |
| `return address` | **`pop rdi ; ret`** |
| ... | **`"/bin/sh" address`** |
| ... | **`xor rsi, rsi; ret`** |
| ... | **`xor rdx, rdx; ret`** |
| ... | **`syscall`** |

## Tools

- [ROPgadget](https://github.com/JonathanSalwan/ROPgadget)
- [ropper](https://github.com/sashs/Ropper)

## ROP in x64 / x86

- Loading a constant into register
    - `pop REG ; ret`
- Set register to 0
    - `xor REG, REG ; ret`
- Move / swap two registers
    - `mov REG1, REG2 ; ret`
    - `push REG1 ; pop REG2 ; ret`
- Arithmetics
    - `xor REG1, REG2 ; ret`
    - `add REG, 0x80 ; ret`
    - ...
- Loading value into register from memory
    - `mov REG, [rbp] ; ret`
- Loading value into memory from register
    - `mov [rbp], REG ; ret`
- Syscall
    - `syscall ; ret`
- Nop
    - `ret`
- Jump to another gadget ([stack pivoting](#Stack-pivoting))
    - `pop rsp ; ret`
    - `xchg REG, rsp`
    - `leave ; ret`

## ROP in aarch64
