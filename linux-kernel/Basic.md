# Linux Kernel Basics

## Build Kernel From Source

- Script
    ```bash
    git clone --depth=1 --branch v4.19.98 git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
    make allnoconfig
    make menuconfig
    ```
- Menu options
    ```
    # Kernel hacking >
    #   Compile-time checks and compiler options >
    #     [*] Compile the kernel with debug info
    #     [*] Provide GDB scripts for kernel debugging
    # ...
    ```

## Build Kernel & Initramfs using buildroot

- [buildroot](https://github.com/buildroot/buildroot)
- Script
    ```bash
    git clone https://github.com/buildroot/buildroot
    cd buildroot
    make qemu_x86_64_defconfig
    make menuconfig
    # System configuration >
    #   [*] Enable root login with password
    # Kernel >
    #   [*] Linux Kernel >
    #     Kernel version (Custom version) >
    #       (x) Custom version
    # Target packages >
    #   [*] Show packages that are also provided by busybox
    #   Networking applications
    #     [*] dhcpd
    #     [*] ifupdown scripts
    #     [*] iproute2
    #     [*] net-tools
    #     [*] netcat
    #     [*] openssh
    make linux-menuconfig
    # Kernel hacking >
    #   Compile-time checks and compiler options >
    #     [*] Compile the kernel with debug info
    #     [*] Provide GDB scripts for kernel debugging
    # ...
    ```

## Extract Kernel Image

* [Extract vmlinux](https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux)

## Initramfs

* Extract initramfs
    ```bash
    gunzip ./initramfs.cpio.gz
    cpio -idv < initramfs.cpio
    ```
* Build initramfs
    ```bash
    find . -print0 | cpio -ov --owner root --null --format=newc | gzip -9 > initramfs.cpio.gz
    ```

## Debugging the kernel

- Add `-gdb tcp::1234` or `-s` after qemu
    ```bash
    qemu-system-x86_64 \
        -kernel bzImage \
        -initrd initramfs.cpio.gz \
    ...
        -gdb tcp::1234
    ```
- Gdb commands:
    ```
    $ gdb -q
    (gdb) file vmlinux
    (gdb) add-symbol-file vuln.ko 0xffffffffc00000
    (gdb) target remote localhost:1234
    ```

## Useful files for kernel exploitation

- `/proc/kallsyms`
    - Lists addresses of symbols loaded into the kernel.
    - Restricted by `kernel.kptr_restrict`
        - 0: No restriction
        - 1: Prints 0 on all symbols unless the user has `CAP_SYSLOG`
        - 2: Prints 0 on all symbols
    - Turn off `kernel.kptr_restrict` temporarily
        ```bash!
        echo 0 > /proc/sys/kernel/kptr_restrict
        ```
    - Example
        - find the address of `commit_creds`
            ```bash!
            grep commit_creds /proc/kallsyms
            ```
- `/proc/modules`
    - List all modules loaded into the kernel.
    - e.g. Find module base address
        ```
        cat /proc/modules
        ```
- `/sys/module/core/sections/.text`
    - Shows the kernel's base address.

## Kernel Security Mitigations

- **KASLR**
    - ALSR in kernel land.
    - Qemu:
        - On: `-append "kaslr"`
        - Off: `-append "nokaslr"`
- **SMEP** (Supervisor Mode Execution Prevention):
    - Mark all user land pages as non-executable when the process is in kernel mode.
    - Qemu
        - On: `-cpu +smep`
        - Off: `-append "nosmep"`
- **SMAP** (Supervisor Mode Access Prevention):
    - Mark all user land pages as non-readable and non-writable when the process is in kernel mode. (Complement of SMEP)
    - Qemu
        - On: `-cpu +smep`
        - Off: `-append "nosmap"`
- **KPTI** (Kernel Page Isolation Table):
    - The kernel separates user land pages and kernel land pages entirely.
    - Qemu
        - On: `-append "kpti=1"`
        - Off: `-append "nopti"`

## Attack Methods

- Exploitation through credential
    - Calls `commit_creds(prepare_kernel_cred(0))` in kernel space
    - Change `task_struct->cred->uid`, `task_struct->cred->gid`, `task_struct->cred->euid` to 0
- Arbitrary file write
    - Add entry to `/etc/passwd`, `/etc/shadow`, `/etc/sudoers`, etc.
- SUID binaries
