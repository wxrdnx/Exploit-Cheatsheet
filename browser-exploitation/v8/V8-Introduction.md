# v8 Introduction

## Build V8

- Build V8 via depot\_tools
    ```bash
    fetch V8
    cd v8
    gclient sync
    ./tools/dev/v8gen.py x64.release
    ninja -C ./out.gn/x64.release
    ./tools/dev/v8gen.py x64.debug
    ninja -C ./out.gn/x64.debug
    ```

## Debug v8

### Using d8 to debug

- Useful d8 flags
    -  `--allow-natives-syntax`.
        - Allow users to call V8 Runtime Functions
    - `--shell`
        - Run an interactive JavaScript shell
- Common V8 Runtime Functions
    - `%DebugPrint()`: print the debug message of a variable
    - `%DebugPrintPtr()`: print the debug message of a variable
    - `%SystemBreak()`: break into the debugger.
- Example
    ```
    gdb --args ./d8 --allow-natives-syntax --shell exploit.js
    pwndbg> run
    ...
    V8 version 7.5.0 (candidate)
    d8> a = [1, 2, 3]
    [1, 2, 3]
    d8> %DebugPrint(a)
    DebugPrint: 0x11a7c558dd39: [JSArray]
     - map: 0x077588a42d99 <Map(PACKED_SMI_ELEMENTS)> [FastProperties]
     - prototype: 0x2dd31fdd1111 <JSArray[0]>
     - elements: 0x11a7c558dcc9 <FixedArray[3]> [PACKED_SMI_ELEMENTS (COW)]
     - length: 3
     - properties: 0x36dee8600c71 <FixedArray[0]> {
        #length: 0x025db7b801a9 <AccessorInfo> (const accessor descriptor)
     }
     - elements: 0x11a7c558dcc9 <FixedArray[3]> {
               0: 1
               1: 2
               2: 3
     }
    0x77588a42d99: [Map]
     - type: JS_ARRAY_TYPE
     - instance size: 32
     - inobject properties: 0
     - elements kind: PACKED_SMI_ELEMENTS
     - unused property fields: 0
     - enum length: invalid
     - back pointer: 0x36dee86004d1 <undefined>
     - prototype_validity cell: 0x025db7b80609 <Cell value= 1>
     - instance descriptors (own) #1: 0x2dd31fdd1f49 <DescriptorArray[1]>
     - layout descriptor: (nil)
     - transitions #1: 0x2dd31fdd1e59 <TransitionArray[4]>Transition array #1:
         0x36dee8604ba1 <Symbol: (elements_transition_symbol)>: (transition to HOLEY_SMI_ELEMENTS) -> 0x077588a42e89 <Map(HOLEY_SMI_ELEMENTS)>

     - prototype: 0x2dd31fdd1111 <JSArray[0]>
     - constructor: 0x2dd31fdd0ec1 <JSFunction Array (sfi = 0x25db7b8aca1)>
     - dependent code: 0x36dee86002c1 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
     - construction counter: 0

    [1, 2, 3]
    d8> 
    ```

## V8 Internal

### Pointer compression

- Before v8 has pointer compression
    - All pointers in the v8 heap were stored as 64-bit pointers
    - However, since the first 32 bits of each pointer are equal, storing them is a waste of memory
- Eventually, the Chromium team decided to adopt **pointer compression** described [here](https://docs.google.com/document/d/10qh2-b4C5OtSg-xLwyZpEI5ZihVBPtn1xwKBbQC26yI/edit)
    - Every value (including Smis, references, etc.) is stored as a 32 bits integer in the v8 heapâ€™s memory space
    - [Value tagging](https://v8.dev/blog/pointer-compression#value-tagging-in-v8)
        - Last lower bit:
            - 0: Small integers (Smis)
            - 1: Heap objects
        - Second lower bit
            - 0: strong references
            - 1: weak references
    - `r13` stores the **isolate root**.
- Short summary
    - For Smis, the value is stored as `value << 1`
    - For pointer references, only the last 32 bit pointer offset is stored
        - This means that the exact memory location can calculated as `r13 + offset` 
- Example
    - Smi: `[xx...31...xxx]0`
        - e.g. `0x000000c0` is `0xc0 >> 1 = 0x60`
    - Strong HeapObject: `[xx...30...xx]01`
        - e.g. `0x08084271` is `r13 + 0x08084270`
    - Weak HeapObject: `[xx...30...xx]11`
